zookeeper
一直琢磨着分布式的东西怎么搞，公司也没有相关的项目能够参与，所以还是回归自己的专长来吧——基于ZooKeeper的分布式队列爬虫，由于没什么人能够一起沟通分布式的相关知识，下面的小项目纯属“胡编乱造”。
简单介绍下[ZooKeeper](http://zookeeper.apache.org/)：ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，是Google的Chubby一个开源的实现，它是集群的管理者，监视着集群中各个节点的状态根据节点提交的反馈进行下一步合理操作。最终，将简单易用的接口和性能高效、功能稳定的系统提供给用户。
基本的知识就不过多介绍了，可以参考参考下面这些人的：
[ZooKeeper官网](http://zookeeper.apache.org/)  
[http://www.cnblogs.com/wuxl360/p/5817471.html](http://www.cnblogs.com/wuxl360/p/5817471.html)

# 整体架构
<div align="center">

![](http://image.wenzhihuai.com/images/20171026080355.png)

</div>

最基本的分布式队列即一个生产者不断抓取链接，然后将链接存储进ZooKeeper的队列节点里，每个节点的value都只是链接，然后消费者从中获取一条url进行抓取。本项目生产这主要是用来生产URL即可，这部分就不要要求太多。然后是消费者，消费者需要解决的问题有：  
1.队列如何保证自己的分发正确；  
2.消费这如何进行高效的抓取。



# ZooKeeper队列原理
创建完节点之后，根据下面的4个步骤来决定执行的顺序。
1.通过调用getChildren()接口来获取某一节点下的所有节点，即获取队列中的所有元素。  
2.确定自己的节点序号在所有子节点中的顺序。  
3.如果自己不是序号最小的子节点，那么就需要进入等待，同时向比自己序号小的最后一个节点注册Watcher监听。  
4.接收到Watcher通知后，重复步骤1。  

<div align="center">

![](http://image.wenzhihuai.com/images/20171028030927.png)

</div>










# 源码分析










# 多线程并发





# 实验结果
生产者生产URL：
<div align="center">

![](http://image.wenzhihuai.com/images/20171026083433.png)

</div>







单机模式下的消费者，耗时：560825/1000/60=9分钟

<div align="center">

![](http://image.wenzhihuai.com/images/20171026084324.png)

</div>





分布式模式下，耗时：564374/1000/60=9分钟
<div align="center">

![](http://image.wenzhihuai.com/images/20171026075704.png)

</div>
<div align="center">

![](http://image.wenzhihuai.com/images/20171026080855.png)

</div>

由图可见，当每个消费者处理能力大于队列分配的能力时，耗时的过程反而是在队列

# 实验二
实验二的主要目的是将消费者的处理时间延长，因为一般情况下，消费者可不是仅仅为了获取网页的title，还要进行其他处理，比如使用正则表达式或者xpath去获取所需要的元素，提取关键的东西，然后存储于数据库或者文件中，这些操作都是及其耗时的，本实验主要目的是队列的使用，就不再提取关键词、存储数据库了，我们使用Thread.sleep(n)来模拟时长。
```java
public static void sleepUtil(Integer time) {
    try {
        Thread.sleep(time * 1000);
    } catch (Exception e) {
        logger.error("线程sleep异常", e);
    }
}
```

此时再看程序的输出，可以看出，队列的分发能力已经大于消费者的处理能力，总算是正常了。
<div align="center">

![](http://image.wenzhihuai.com/images/20171027020525.png)

</div>

<div align="center">

![](http://image.wenzhihuai.com/images/20171027070324.png)

</div>

